<!DOCTYPE html>
<html>
  <head>
    <title>Tutorial Maker 2</title>
    <script src="/core/libs/jszip.min.js"></script>
    <style>
      .upload-section {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px dashed #ccc;
      }
    </style>
  </head>
  <body>
    <h1>Tutorial Maker 2</h1>
    <div class="upload-section">
      <p>Upload ZIP file with metadata.json:</p>
      <input 
        type="file" 
        id="zipUpload" 
        accept=".zip"
        onclick="console.log('ZIP input clicked')"
        onchange="console.log('ZIP input changed')"
      >
    </div>
    <form 
      id="dataForm"
      onsubmit="console.log('Form submit triggered');"
    >
      <label for="firstName">First Name:</label>
      <input type="text" id="firstName" required><br>
      <label for="lastName">Last Name:</label>
      <input type="text" id="lastName" required><br>
      <label for="title">Title:</label>
      <input type="text" id="title" required><br>
      <button type="submit">Submit</button>
    </form>

    <script>
      function postDownloadMessage(data) {
        window.opener.postMessage({ type: 'TM_METADATA_DOWNLOAD', data: data }, '*');
      }

      function fillMetadata(metadata) {
        const metadataArray = Array.isArray(metadata) 
          ? metadata 
          : Object.entries(metadata).map(([key, value]) => ({ id: key, value: value }));
        
        metadataArray.forEach(property => {
          const fieldElement = document.getElementById(property.id);
          if (fieldElement) {
            fieldElement.value = property.value || '';
          } else {
            console.error(`Element not found for id: ${property.id}`);
          }
        });
      }

      async function handleFileUpload(event) {
        event.preventDefault();
        event.stopPropagation();

        const file = event.target.files[0];

        if (file && file.name.endsWith('.zip')) {
          try {
            const zip = await JSZip.loadAsync(file);
            const metadataFile = zip.file("metadata.json");
            
            if (!metadataFile) {
              console.error('No metadata.json found in zip file');
              return;
            }
            try {
              const metadataContent = await metadataFile.async("string");
              const metadata = JSON.parse(metadataContent);
              fillMetadata(metadata);
            } catch (innerError) {
              console.error('Error in metadata processing:', innerError);
              console.error('Inner error details:', {
                name: innerError.name,
                message: innerError.message,
                stack: innerError.stack
              });
            }
            
          } catch (error) {
            console.error('Error processing zip file:', error);
            console.error('Error details:', {
              name: error.name,
              message: error.message,
              stack: error.stack
            });
          }
        } else {
          console.error('Invalid file:', file ? `${file.name} is not a zip file` : 'No file selected');
        }
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        event.stopPropagation();
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const title = document.getElementById('title').value;

        const data = {
          firstName,
          lastName,
          title
        };

        window.postDownloadMessage(data);
      }

      window.onload = function() {
        const zipUpload = document.getElementById('zipUpload');
        zipUpload.addEventListener('change', handleFileUpload);
        document.getElementById('dataForm').onsubmit = handleFormSubmit;
      };
    </script>
  </body>
</html>